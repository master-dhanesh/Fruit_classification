name: CD - Build & Deploy Backend to EC2

on:
    push:
        branches: ["main"]
        paths:
            - "backend/**"
            - "models/**"
            - "docker/backend.Dockerfile"
            - ".github/workflows/cd.yml"

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Docker Hub login
              run: |
                  echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build & Push (multi-arch)
              run: |
                  docker buildx build \
                    --platform linux/amd64,linux/arm64 \
                    -t tempmaster/fruit-backend:latest \
                    -t tempmaster/fruit-backend:${{ github.sha }} \
                    -f docker/backend.Dockerfile \
                    --push .

            - name: Prepare SSH key
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
                  chmod 600 ~/.ssh/ec2_key.pem
                  ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy on EC2 (pull + restart container)
              run: |
                  ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                    set -e

                    docker pull tempmaster/fruit-backend:latest
                    docker rm -f fruit-backend || true

                    docker run -d \
                      --name fruit-backend \
                      --restart=always \
                      -p 8000:8000 \
                      -e MODEL_PATH=/app/models/latest_model.keras \
                      tempmaster/fruit-backend:latest

                    docker image prune -f
                    sleep 2
                    curl -s http://localhost:8000/health || true
                  EOF
